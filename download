#!/usr/bin/env bash

MAX_PAGES=20

getResultsPages() {
  keyword=$1

  mkdir -p pages

  # active Next   = <a href="/auto/search/index?page=2" title="Go forward 1 page">Next Â»</a>
  # inactive Next = <span style="color: gray"> | Next</span>

  for page in $(seq 1 $MAX_PAGES); do
    url="http://www.ksl.com/auto/search/index?keyword=$keyword&page=$page"
    echo "downloading $url"
    curl $url > pages/page$page
    sleep 1
  done
}

extractListingIds() {
  # example /auto/listing/2162162?ad_cid=1
  grep -oE '/auto\/listing\/[0-9]+' pages/page* |cut -d '/' -f5 |uniq > listing-ids
}

getListings() {
  file=$1
  mkdir -p listings

  for id in $(cat $file); do
    path=listings/$id

    if test -f $path; then
      echo $path exists
    else
      url="http://www.ksl.com/auto/listing/$id"
      echo "downloading $id $url"
      curl "$url" > $path
    fi

    sleep 0.05
  done
}

main() {
  searchTerm=$1
  getResultsPages $searchTerm
  extractListingIds
  getListings uniq-listings
}

main $@
